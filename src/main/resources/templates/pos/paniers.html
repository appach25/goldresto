<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>Paniers en cours - Gold Resto</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .card {
            transition: transform 0.2s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .products-list {
            max-height: 200px;
            overflow-y: auto;
        }
        .table-number {
            font-size: 1.5rem;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div th:replace="fragments/navbar :: navbar"></div>

    <div class="container mt-5 pt-3">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Commandes en cours</h2>
            <div class="d-flex align-items-center">
                <div class="input-group" style="width: 300px;">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="number" class="form-control" id="tableSearch" placeholder="Rechercher une table..." min="1">
                </div>
            </div>
        </div>
        
        <div class="alert alert-danger" th:if="${error != null}">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <span th:text="${error}"></span>
        </div>

        <div class="alert alert-info" th:if="${error == null and #lists.isEmpty(paniers)}">
            <i class="bi bi-info-circle me-2"></i> Aucune commande en cours.
        </div>

        <div class="row mt-4 g-4" th:if="${not #lists.isEmpty(paniers)}">
            <div class="col-md-6 col-lg-4" th:each="panier : ${paniers}">
                <div class="card h-100 shadow-sm panier-card" th:data-table-number=${panier.numeroTable}>
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-table me-2"></i>
                            <span class="table-number" th:text="'Table ' + ${panier.numeroTable}"></span>
                        </div>
                        <small th:text="${#temporals.format(panier.date, 'dd/MM/yyyy HH:mm')}"></small>
                    </div>
                    <div class="card-body">
                        <div class="products-list mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2" 
                                 th:each="ligne : ${panier.lignesProduits}">
                                <div>
                                    <span class="fw-bold" th:text="${ligne?.produit?.nomProduit ?: 'Produit inconnu'}"></span>
                                    <small class="text-muted" th:text="'x' + ${ligne.quantite}"></small>
                                </div>
                                <span th:text="'$' + ${#numbers.formatDecimal(ligne.sousTotal, 1, 2)}"></span>
                            </div>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Total</h5>
                            <h5 class="mb-0" th:text="'$' + ${#numbers.formatDecimal(panier.total, 1, 2)}"></h5>
                        </div>
                        <div class="d-grid gap-2">
                            <!-- Action buttons group -->
                            <div class="btn-group mb-2" role="group">
                                <button class="btn btn-primary"
                                        th:onclick="'addProduitToPanier(' + ${panier.id} + ')'">
                                    <i class="bi bi-plus-square me-2"></i> Ajouter
                                </button>
                            </div>
                            <!-- Payment button -->
                            <button class="btn btn-primary"
                                    th:onclick="'processPaiement(' + ${panier.id} + ', ' + ${panier.total} + ')'">
                                <i class="bi bi-credit-card me-2"></i> Procéder au paiement
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de paiement -->
    <div class="modal fade" id="checkoutModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Paiement</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="paiementForm">
                        <div class="mb-3">
                            <label for="montantAPayer" class="form-label">Montant à payer</label>
                            <input type="number" class="form-control" id="montantAPayer" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="cashRecu" class="form-label">Montant reçu</label>
                            <input type="number" class="form-control" id="cashRecu" step="0.01" required min="0" oninput="validateCashAmount(this)">
                            <div class="invalid-feedback">Le montant reçu doit être supérieur ou égal au montant à payer</div>
                        </div>
                        <div class="mb-3">
                            <label for="monnaie" class="form-label">Monnaie à rendre</label>
                            <input type="number" class="form-control" id="monnaie" readonly>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" onclick="confirmPaiement()">Confirmer</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/decimal.js@10.4.3/decimal.min.js"></script>
    
    <script th:inline="javascript">
        let currentPanierId = null;

        
        // Search functionality
        document.getElementById('tableSearch').addEventListener('input', function(e) {
            const searchValue = e.target.value;
            const cards = document.querySelectorAll('.panier-card');
            
            cards.forEach(card => {
                const tableNumber = card.getAttribute('data-table-number');
                if (!searchValue || tableNumber.includes(searchValue)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        });

        function processPaiement(panierId, total) {
            currentPanierId = panierId;
            document.getElementById('montantAPayer').value = total;
            document.getElementById('cashRecu').value = '';
            document.getElementById('monnaie').value = '';
            new bootstrap.Modal(document.getElementById('checkoutModal')).show();
        }

        function validateCashAmount(input) {
            const montantAPayer = new Decimal(document.getElementById('montantAPayer').value);
            const cashRecu = new Decimal(input.value || 0);
            const monnaie = cashRecu.minus(montantAPayer);
            document.getElementById('monnaie').value = monnaie.toFixed(2);

            // Validate amount
            if (cashRecu.lessThan(montantAPayer)) {
                input.classList.add('is-invalid');
                document.querySelector('.btn-primary[onclick="confirmPaiement()"]').disabled = true;
            } else {
                input.classList.remove('is-invalid');
                document.querySelector('.btn-primary[onclick="confirmPaiement()"]').disabled = false;
            }
        }

        document.getElementById('cashRecu').addEventListener('input', function() {
            validateCashAmount(this);
        });

        function confirmPaiement() {
            if (!currentPanierId) return;

            const cashRecu = parseFloat(document.getElementById('cashRecu').value);
            const montantAPayer = parseFloat(document.getElementById('montantAPayer').value);

            if (isNaN(cashRecu) || cashRecu < montantAPayer) {
                alert('Le montant reçu doit être supérieur ou égal au montant à payer');
                return;
            }

            const paiement = {
                cashRecu: cashRecu,
                montantAPayer: montantAPayer
            };

            const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

            if (!csrfToken || !csrfHeader) {
                alert('Erreur: CSRF tokens non trouvés');
                return;
            }

            fetch(`/pos/paiement/${currentPanierId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken
                },
                body: JSON.stringify(paiement)
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text); });
                }
                return response.json();
            })
            .then(() => {
                alert('Paiement effectué avec succès !');
                location.reload();
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Erreur lors du paiement: ' + error.message);
            });
        }

        let selectedPanierId = null;

        function addProduitToPanier(panierId) {
            window.location.href = '/pos?addProduitPanierId=' + panierId;
        }
    </script>
</body>
</html>
