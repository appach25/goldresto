<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Gold Resto POS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/main.css" rel="stylesheet">
    <style>
        .product-grid {
            height: calc(100vh - 170px);
            overflow-y: auto;
        }
        .cart-section {
            height: calc(100vh - 170px);
            background-color: #f8f9fa;
            border-left: 1px solid #dee2e6;
        }
        .product-card {
            cursor: pointer;
            transition: transform 0.2s;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .product-image {
            height: 120px;
            object-fit: cover;
        }
        .cart-items {
            height: calc(100vh - 420px); /* Adjusted for fixed navbar */
            overflow-y: auto;
        }
        .quantity-control {
            width: 120px;
        }
    </style>
</head>
<body>
    <div th:replace="fragments/navbar :: navbar"></div>

<div class="container-fluid">
        <div class="row">
            

            <!-- Products Grid -->
            <div class="col-md-8 product-grid p-4">
                <div class="row g-4">
                    <div th:each="produit : ${produits}" class="col-6 col-md-4 col-lg-3">
                        <div class="card product-card" 
                            th:data-produit-id=${produit.id} 
                            th:data-nom=${#strings.escapeJavaScript(produit.nomProduit)}
                            th:data-prix=${#numbers.formatDecimal(produit.prix,1,2)}
                            th:data-promo-qty=${produit.promoQty}
                            th:data-promo-price=${#numbers.formatDecimal(produit.promoPrice,1,2)}
                            th:data-stock=${produit.stock}
                            th:onclick="|addToCart(${produit.id})|">
                            <img th:if="${produit.imagePath}" 
                                 th:src="@{'/'+${produit.imagePath}}" 
                                 class="card-img-top product-image"
                                 th:alt="${produit.nomProduit}">
                            <div class="card-body">
                                <h6 class="card-title" th:text="${produit.nomProduit}">Nom du produit</h6>
                                <p class="card-text">
                                    <span class="badge bg-info" th:text="${produit.categorie}">Catégorie</span>
                                    
                                </p>
                                <p class="card-text">
                                    <strong class="text-end" th:text="'$' + ${#numbers.formatDecimal(produit.prix, 1, 2)}">$0.00</strong>
                                </p>
                               
                                
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cart Section -->
            <div class="col-md-4 cart-section p-4">
                <h4>COMMANDE</h4>
                
                <!-- Table Number -->
                <div class="mb-4">
                    <label for="tableNumber" class="form-label">Numéro de table</label>
                    <select class="form-select" id="tableNumber" onchange="validateTableNumber(this.value)">
                        <option value="">Sélectionnez une table</option>
                        <!-- Table numbers will be populated dynamically -->
                    </select>
                    <div id="tableNumberFeedback" class="invalid-feedback"></div>
                </div>

                <!-- Cart Items -->
                <div class="cart-items mb-4">
                    <div id="cartItemsList">
                        <!-- Cart items will be dynamically added here -->
                    </div>
                </div>

                <!-- Cart Summary -->
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Total</h5>
                        <h3 class="card-text mb-4" id="cartTotal">$0.00</h3>
                        <button id="validateButton" class="btn btn-primary w-100" onclick="validatePanier()">
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            <span class="button-text">Valider la commande</span>
                        </button>
                    </div>
                </div>

                

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.4.3/decimal.min.js"></script>
    <script>
        let currentPanier = null;
        let cartItems = new Map();

        function addToCart(produitId) {
            const existingItem = cartItems.get(produitId);
            if (existingItem) {
                // Only allow increment if not readonly
                if (!existingItem.readonly) {
                    existingItem.quantity++;
                    updateCartDisplay();
                }
            } else {
                const produitCard = document.querySelector(`[data-produit-id='${produitId}']`);
                const produit = {
                    id: produitId,
                    nomProduit: produitCard.dataset.nom,
                    prix: parseFloat(produitCard.dataset.prix),
                    promoQty: produitCard.dataset.promoQty ? parseInt(produitCard.dataset.promoQty) : null,
                    promoPrice: produitCard.dataset.promoPrice ? parseFloat(produitCard.dataset.promoPrice) : null,
                    stock: parseInt(produitCard.dataset.stock)
                };
                cartItems.set(produitId, {
                    produit: produit,
                    quantity: 1,
                    readonly: false // new items are editable
                });
                updateCartDisplay();
            }
        }

        function updateQuantity(produitId, delta) {
            const item = cartItems.get(produitId);
            if (item) {
                // For readonly items, only allow increment (delta > 0)
                if (item.readonly) {
                    if (delta > 0) {
                        item.quantity = item.quantity + delta;
                        updateCartDisplay();
                    }
                    // Ignore decrement for readonly items
                } else {
                    item.quantity = Math.max(1, item.quantity + delta);
                    updateCartDisplay();
                }
            }
        }

        function removeItem(produitId) {
            const item = cartItems.get(produitId);
            if (item && !item.readonly) {
                cartItems.delete(produitId);
                updateCartDisplay();
            }
        }

        async function fetchPanierTotal(panierId) {
            try {
                const response = await fetch(`/pos/panier/${panierId}/total`);
                if (!response.ok) throw new Error('Erreur lors du calcul du total');
                const total = await response.json();
                document.getElementById('cartTotal').textContent = '$' + Number(total).toFixed(2);
            } catch (error) {
                document.getElementById('cartTotal').textContent = '$0.00';
            }
        }

        function updateCartDisplay() {
            const cartList = document.getElementById('cartItemsList');
            cartList.innerHTML = '';
            let total = new Decimal(0);

            cartItems.forEach((item, produitId) => {
                if (item.produit && item.produit.prix) {
                    let sousTotal = new Decimal(0);
                    const unit = new Decimal(item.produit.prix);
                    const qty = item.quantity;
                    const promoQty = item.produit.promoQty;
                    const promoPrice = item.produit.promoPrice != null ? new Decimal(item.produit.promoPrice) : null;

                    if (promoQty && promoQty > 0 && promoPrice && promoPrice.greaterThanOrEqualTo(0)) {
                        const bundles = Math.floor(qty / promoQty);
                        const remainder = qty % promoQty;
                        const bundlesTotal = promoPrice.times(bundles);
                        const remainderTotal = unit.times(remainder);
                        sousTotal = bundlesTotal.plus(remainderTotal);
                    } else {
                        sousTotal = unit.times(qty);
                    }
                    total = total.plus(sousTotal);

                    cartList.innerHTML += `
                        <div class="card mb-2">
                            <div class="card-body">
                                <h6 class="card-title">${item.produit.nomProduit}</h6>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="quantity-control input-group">
                                        <button class="btn btn-outline-secondary" onclick="updateQuantity(${produitId}, -1)" ${item.readonly ? 'disabled' : ''}>-</button>
                                        <input type="number" class="form-control text-center" value="${item.quantity}" readonly>
                                        <button class="btn btn-outline-secondary" onclick="updateQuantity(${produitId}, 1)">
                                            <i class="bi bi-plus"></i>
                                        </button>
                                    </div>
                                    <span>$${sousTotal.toFixed(2)}</span>
                                    <button class="btn btn-danger btn-sm" onclick="removeItem(${produitId})" ${item.readonly ? 'disabled' : ''}>
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });

            // Always fetch backend total for existing panier
            if (currentPanier && currentPanier.id) {
                fetchPanierTotal(currentPanier.id);
            } else {
                // Only show frontend total for new paniers not yet saved
                document.getElementById('cartTotal').textContent = '$' + total.toFixed(2);
            }
        }

        async function validateTableNumber(tableNumber) {
            if (!tableNumber) {
                const tableSelect = document.getElementById('tableNumber');
                const feedback = document.getElementById('tableNumberFeedback');
                tableSelect.classList.add('is-invalid');
                feedback.textContent = 'Veuillez sélectionner une table';
                return false;
            }

            // Refresh table numbers to ensure we have the latest state
            await populateTableNumbers();
            
            try {
                const response = await fetch(`/pos/panier/checkNumeroTable?numeroTable=${tableNumber}`);
                const isTableInUse = await response.json();
                const tableSelect = document.getElementById('tableNumber');
                const feedback = document.getElementById('tableNumberFeedback');
                
                if (isTableInUse) {
                    tableSelect.classList.add('is-invalid');
                    feedback.textContent = 'Cette table est déjà occupée';
                    return false;
                } else {
                    tableSelect.classList.remove('is-invalid');
                    feedback.textContent = '';
                    return true;
                }
            } catch (error) {
                console.error('Error validating table:', error);
                return false;
            }
        }

        // Utility to get query param
        function getQueryParam(name) {
            const url = new URL(window.location.href);
            return url.searchParams.get(name);
        }

        // Function to populate available tables
        async function populateTableNumbers() {
            const tableSelect = document.getElementById('tableNumber');
            const currentValue = tableSelect.value;
            tableSelect.innerHTML = '<option value="">Sélectionnez une table</option>';

            // Get occupied tables
            const occupiedTables = new Set();
            try {
                const response = await fetch('/pos/panier/occupiedTables');
                if (response.ok) {
                    const tables = await response.json();
                    tables.forEach(table => occupiedTables.add(table));
                }
            } catch (error) {
                console.error('Error fetching occupied tables:', error);
            }

            // Add regular table numbers 1-50
            for (let i = 1; i <= 50; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Table ${i}`;
                if (occupiedTables.has(i)) {
                    option.disabled = true;
                    option.textContent += ' (Occupée)';
                }
                tableSelect.appendChild(option);
            }

            // Add takeaway tables 51-61
            for (let i = 51; i <= 61; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `A emporter ${i}`;
                if (occupiedTables.has(i)) {
                    option.disabled = true;
                    option.textContent += ' (Occupée)';
                }
                tableSelect.appendChild(option);
            }

            // Restore previous selection if valid
            if (currentValue && !occupiedTables.has(parseInt(currentValue))) {
                tableSelect.value = currentValue;
            }
        }

        // On page load, check if editing or adding product to a panier
        window.addEventListener('DOMContentLoaded', async () => {
            // Populate table numbers initially
            await populateTableNumbers();
            const editPanierId = getQueryParam('editPanierId');
            const addProduitPanierId = getQueryParam('addProduitPanierId');
            if (editPanierId) {
                await editPanier(editPanierId);
            } else if (addProduitPanierId) {
                await editPanier(addProduitPanierId, true); // pass flag to clear quantities
            }
        });

        // Modified editPanier to accept a flag for clearing quantities
        async function editPanier(panierId, clearQuantities = false) {
            try {
                const response = await fetch(`/pos/panier/${panierId}`);
                const panierData = await response.json();
                const panier = panierData.value ? panierData.value : panierData;

                document.getElementById('tableNumber').value = panier.numeroTable;
                cartItems.clear();

                // Only show existing products if we're not adding new products
                if (!clearQuantities && panier.lignesProduits) {
                    panier.lignesProduits.forEach(ligne => {
                        cartItems.set(ligne.produit.id, {
                            produit: {
                                id: ligne.produit.id,
                                nomProduit: ligne.produit.nomProduit,
                                prix: ligne.produit.prix,
                                stock: ligne.produit.stock
                            },
                            quantity: ligne.quantite,
                            readonly: true // mark as readonly
                        });
                    });
                }

                currentPanier = panier;
                updateCartDisplay();
            } catch (error) {
                alert('Erreur lors du chargement du panier');
                console.error(error);
            }
        }

        async function validatePanier() {
            const validateButton = document.getElementById('validateButton');
            const spinner = validateButton.querySelector('.spinner-border');
            const buttonText = validateButton.querySelector('.button-text');

            // Prevent double submission
            if (validateButton.disabled) {
                return;
            }

            try {
                // Disable button and show loading state
                validateButton.disabled = true;
                spinner.classList.remove('d-none');
                buttonText.textContent = 'Validation en cours...';

                if (cartItems.size === 0) {
                    alert('Ajouter produit SVP');
                    return;
                }

                const tableNumber = document.getElementById('tableNumber').value;
                if (!tableNumber) {
                    alert('Veuillez entrer un numéro de table');
                    return;
                }

                // If editing or adding product to existing panier
                if (currentPanier && currentPanier.id) {
                    try {
                        const products = [];
                        cartItems.forEach((item, produitId) => {
                            if (!item.readonly) { // Only add new items
                                products.push({
                                    produitId: produitId,
                                    quantite: item.quantity,
                                    prixUnitaire: item.produit.prix
                                });
                            }
                        });

                        // Add new products one by one
                        for (const product of products) {
                            const response = await fetch(`/pos/panier/${currentPanier.id}/addProduct?produitId=${product.produitId}&quantite=${product.quantite}`, {
                                method: 'POST'
                            });
                            
                            if (!response.ok) {
                                const errorText = await response.text();
                                alert(errorText);
                                throw new Error(errorText);
                            }
                        }

                        // Redirect back to paniers list
                        window.location.href = '/pos/paniers';
                        return;
                    } catch (error) {
                        alert('Erreur lors de l\'ajout des produits: ' + error.message);
                        return;
                    }
                }

                // Create a new panier with products
                const products = [];
                let total = new Decimal(0);
                
                cartItems.forEach((item, produitId) => {
                    const prixUnitaire = new Decimal(item.produit.prix);
                    const sousTotal = prixUnitaire.times(item.quantity);
                    total = total.plus(sousTotal);
                    
                    products.push({
                        produitId: produitId,
                        quantite: item.quantity,
                        prixUnitaire: prixUnitaire.toNumber()
                    });
                });

                const panier = {
                    numeroTable: parseInt(tableNumber),
                    state: 'EN_COURS',
                    products: products,
                    total: total.toNumber()
                };

                try {
                    const response = await fetch('/pos/panier/create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(panier)
                    });

                    if (!response.ok) {
                        throw new Error('Failed to create panier');
                    }

                    const savedPanier = await response.json();
                    
                    // Print kitchen receipt
                    const printResponse = await fetch(`/pos/panier/${savedPanier.id}/validate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!printResponse.ok) {
                        throw new Error('Failed to print kitchen receipt');
                    }

                    clearInterface();
                    alert('Commande validée et envoyée à la cuisine !');
                } catch (error) {
                    console.error('Error creating panier:', error);
                    alert('Erreur lors de la validation du panier');
                } finally {
                    validateButton.disabled = false;
                    spinner.classList.add('d-none');
                    buttonText.textContent = 'Valider la commande';
                }
            } catch (error) {
                console.error('Error validating panier:', error);
                alert('Erreur lors de la validation du panier');
            } finally {
                validateButton.disabled = false;
                spinner.classList.add('d-none');
                buttonText.textContent = 'Valider la commande';
            }
        }

        function clearInterface() {
            cartItems.clear();
            currentPanier = null;
            document.getElementById('tableNumber').value = '1';
            document.getElementById('cartTotal').textContent = '$0.00'; // Reset total on clear
            updateCartDisplay();
        }

    </script>
</body>
</html>
</html>
