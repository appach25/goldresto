<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Gold Resto POS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/css/main.css" rel="stylesheet">
    <style>
        .product-grid {
            height: calc(100vh - 170px);
            overflow-y: auto;
        }
        .cart-section {
            height: calc(100vh - 170px);
            background-color: #f8f9fa;
            border-left: 1px solid #dee2e6;
        }
        .product-card {
            cursor: pointer;
            transition: transform 0.2s;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .product-image {
            height: 120px;
            object-fit: cover;
        }
        .cart-items {
            height: calc(100vh - 420px); /* Adjusted for fixed navbar */
            overflow-y: auto;
        }
        .quantity-control {
            width: 120px;
        }
    </style>
</head>
<body>
    <div th:replace="fragments/navbar :: navbar"></div>

<div class="container-fluid">
        <div class="row">
            

            <!-- Products Grid -->
            <div class="col-md-8 product-grid p-4">
                <div class="row g-4">
                    <div th:each="produit : ${produits}" class="col-6 col-md-4 col-lg-3">
                        <div class="card product-card" 
                            th:data-produit-id=${produit.id} 
                            th:data-nom=${#strings.escapeJavaScript(produit.nomProduit)}
                            th:data-prix=${#numbers.formatDecimal(produit.prix,1,2)}
                            th:data-stock=${produit.stock}
                            th:onclick="|addToCart(${produit.id})|">
                            <img th:if="${produit.imagePath}" 
                                 th:src="@{'/'+${produit.imagePath}}" 
                                 class="card-img-top product-image"
                                 th:alt="${produit.nomProduit}">
                            <div class="card-body">
                                <h6 class="card-title" th:text="${produit.nomProduit}">Nom du produit</h6>
                                <p class="card-text">
                                    <span class="badge bg-info" th:text="${produit.categorie}">Catégorie</span>
                                    
                                </p>
                                <p class="card-text">
                                    <strong class="text-end" th:text="'$' + ${#numbers.formatDecimal(produit.prix, 1, 2)}">$0.00</strong>
                                </p>
                               
                                
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cart Section -->
            <div class="col-md-4 cart-section p-4">
                <h4>COMMANDE</h4>
                
                <!-- Table Number -->
                <div class="mb-4">
                    <label for="tableNumber" class="form-label">Numéro de table</label>
                    <input type="number" class="form-control" id="tableNumber" min="1" max="100" value="1" onchange="validateTableNumber(this.value)">
                    <div id="tableNumberFeedback" class="invalid-feedback"></div>
                </div>

                <!-- Cart Items -->
                <div class="cart-items mb-4">
                    <div id="cartItemsList">
                        <!-- Cart items will be dynamically added here -->
                    </div>
                </div>

                <!-- Cart Summary -->
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Total</h5>
                        <h3 class="card-text mb-4" id="cartTotal">$0.00</h3>
                        <button class="btn btn-primary w-100" onclick="validatePanier()">Valider la commande</button>
                    </div>
                </div>

                

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.4.3/decimal.min.js"></script>
    <script>
        let currentPanier = null;
        let cartItems = new Map();

        function addToCart(produitId) {
            const existingItem = cartItems.get(produitId);
            if (existingItem) {
                // Only allow increment if not readonly
                if (!existingItem.readonly) {
                    existingItem.quantity++;
                    updateCartDisplay();
                }
            } else {
                const produitCard = document.querySelector(`[data-produit-id='${produitId}']`);
                const produit = {
                    id: produitId,
                    nomProduit: produitCard.dataset.nom,
                    prix: parseFloat(produitCard.dataset.prix),
                    stock: parseInt(produitCard.dataset.stock)
                };
                cartItems.set(produitId, {
                    produit: produit,
                    quantity: 1,
                    readonly: false // new items are editable
                });
                updateCartDisplay();
            }
        }

        function updateQuantity(produitId, delta) {
            const item = cartItems.get(produitId);
            if (item) {
                // For readonly items, only allow increment (delta > 0)
                if (item.readonly) {
                    if (delta > 0) {
                        item.quantity = item.quantity + delta;
                        updateCartDisplay();
                    }
                    // Ignore decrement for readonly items
                } else {
                    item.quantity = Math.max(1, item.quantity + delta);
                    updateCartDisplay();
                }
            }
        }

        function removeItem(produitId) {
            const item = cartItems.get(produitId);
            if (item && !item.readonly) {
                cartItems.delete(produitId);
                updateCartDisplay();
            }
        }

        async function fetchPanierTotal(panierId) {
            try {
                const response = await fetch(`/pos/panier/${panierId}/total`);
                if (!response.ok) throw new Error('Erreur lors du calcul du total');
                const total = await response.json();
                document.getElementById('cartTotal').textContent = '$' + Number(total).toFixed(2);
            } catch (error) {
                document.getElementById('cartTotal').textContent = '$0.00';
            }
        }

        function updateCartDisplay() {
            const cartList = document.getElementById('cartItemsList');
            cartList.innerHTML = '';
            let total = 0;

            cartItems.forEach((item, produitId) => {
                if (item.produit && item.produit.prix) {
                    const sousTotal = new Decimal(item.produit.prix).times(item.quantity);
                    total = new Decimal(total).plus(sousTotal);

                    cartList.innerHTML += `
                        <div class="card mb-2">
                            <div class="card-body">
                                <h6 class="card-title">${item.produit.nomProduit}</h6>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="quantity-control input-group">
                                        <button class="btn btn-outline-secondary" onclick="updateQuantity(${produitId}, -1)" ${item.readonly ? 'disabled' : ''}>-</button>
                                        <input type="number" class="form-control text-center" value="${item.quantity}" readonly>
                                        <button class="btn btn-outline-secondary" onclick="updateQuantity(${produitId}, 1)">
                                            <i class="bi bi-plus"></i>
                                        </button>
                                    </div>
                                    <span>$${sousTotal.toFixed(2)}</span>
                                    <button class="btn btn-danger btn-sm" onclick="removeItem(${produitId})" ${item.readonly ? 'disabled' : ''}>
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });

            // Always fetch backend total for existing panier
            if (currentPanier && currentPanier.id) {
                fetchPanierTotal(currentPanier.id);
            } else {
                // Only show frontend total for new paniers not yet saved
                document.getElementById('cartTotal').textContent = '$' + total.toFixed(2);
            }
        }

        async function validateTableNumber(tableNumber) {
            try {
                // FIX: Use the correct endpoint as defined in your Spring controller
                const response = await fetch(`/pos/panier/checkNumeroTable?numeroTable=${tableNumber}`);
                const isTableInUse = await response.json();
                const tableInput = document.getElementById('tableNumber');
                const feedback = document.getElementById('tableNumberFeedback');
                
                if (isTableInUse) {
                    tableInput.classList.add('is-invalid');
                    feedback.textContent = 'Cette table est déjà occupée';
                    return false;
                } else {
                    tableInput.classList.remove('is-invalid');
                    feedback.textContent = '';
                    return true;
                }
            } catch (error) {
                console.error('Error validating table:', error);
                return false;
            }
        }

        // Utility to get query param
        function getQueryParam(name) {
            const url = new URL(window.location.href);
            return url.searchParams.get(name);
        }

        // On page load, check if editing or adding product to a panier
        window.addEventListener('DOMContentLoaded', async () => {
            const editPanierId = getQueryParam('editPanierId');
            const addProduitPanierId = getQueryParam('addProduitPanierId');
            if (editPanierId) {
                await editPanier(editPanierId);
            } else if (addProduitPanierId) {
                await editPanier(addProduitPanierId, true); // pass flag to clear quantities
            }
        });

        // Modified editPanier to accept a flag for clearing quantities
        async function editPanier(panierId, clearQuantities = false) {
            try {
                const response = await fetch(`/pos/panier/${panierId}`);
                const panierData = await response.json();
                const panier = panierData.value ? panierData.value : panierData;

                document.getElementById('tableNumber').value = panier.numeroTable;
                cartItems.clear();

                // If clearQuantities is true, do not add previous products to cartItems
                if (!clearQuantities && panier.lignesProduits) {
                    panier.lignesProduits.forEach(ligne => {
                        cartItems.set(ligne.produit.id, {
                            produit: {
                                id: ligne.produit.id,
                                nomProduit: ligne.produit.nomProduit,
                                prix: ligne.produit.prix,
                                stock: ligne.produit.stock
                            },
                            quantity: ligne.quantite,
                            readonly: true // mark as readonly
                        });
                    });
                }
                // If clearQuantities is true, cartItems remains empty (quantities cleared)

                currentPanier = panier;
                updateCartDisplay();
            } catch (error) {
                alert('Erreur lors du chargement du panier');
                console.error(error);
            }
        }

        async function validatePanier() {
            const tableNumber = document.getElementById('tableNumber').value;
            if (!tableNumber) {
                alert('Veuillez entrer un numéro de table');
                return;
            }

            if (!currentPanier || !currentPanier.id) {
                const isTableValid = await validateTableNumber(tableNumber);
                if (!isTableValid) {
                    alert('Cette table est déjà occupée');
                    return;
                }
            }

            // If editing or adding product to existing panier, skip table number validation
            if (currentPanier && currentPanier.id) {
                const promises = [];
                for (const [produitId, item] of cartItems) {
                    try {
                        const frontendTotal = parseFloat(document.getElementById('cartTotal').textContent.replace('$', ''));
                        const response = await fetch(`/pos/panier/${currentPanier.id}/addProduct?produitId=${produitId}&quantite=${item.quantity}&frontendTotal=${frontendTotal}`, {
                            method: 'POST'
                        });
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            alert(errorText);
                            return;
                        }
                        
                        // Update stock display after successful addition
                        const stockSpan = document.querySelector(`#produit_${produitId} .stock-count`);
                        if (stockSpan) {
                            const newStock = parseInt(stockSpan.textContent) - item.quantity;
                            stockSpan.textContent = newStock;
                            const smallElement = stockSpan.closest('small');
                            if (newStock <= 10) {
                                smallElement.classList.remove('text-muted');
                                smallElement.classList.add('text-danger');
                            }
                        }
                    } catch (error) {
                        alert('Erreur lors de l\'ajout du produit: ' + error.message);
                        return;
                    }
                }

                await Promise.all(promises);

                // Send frontend total to backend when validating
                try {
                    const frontendTotal = parseFloat(document.getElementById('cartTotal').textContent.replace('$', ''));
                    await fetch(`/pos/panier/${currentPanier.id}/validate?total=${frontendTotal}`, {
                        method: 'POST'
                    });
                } catch (error) {
                    alert('Erreur lors de la validation du panier');
                    return;
                }

                clearInterface();
                alert('Panier modifié avec succès !');
                return;
            }

            // Create a new panier with products
            const products = [];
            let total = new Decimal(0);
            
            cartItems.forEach((item, produitId) => {
                const prixUnitaire = new Decimal(item.produit.prix);
                const sousTotal = prixUnitaire.times(item.quantity);
                total = total.plus(sousTotal);
                
                products.push({
                    produitId: produitId,
                    quantite: item.quantity,
                    prixUnitaire: prixUnitaire.toNumber()
                });
            });

            const panier = {
                numeroTable: parseInt(tableNumber),
                state: 'EN_COURS',
                products: products,
                total: total.toNumber()
            };

            fetch('/pos/panier/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(panier)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to create panier');
                }
                return response.json();
            })
            .then(() => {
                clearInterface();
                alert('Commande validée !');
            });
        }

        function clearInterface() {
            cartItems.clear();
            currentPanier = null;
            document.getElementById('tableNumber').value = '1';
            document.getElementById('cartTotal').textContent = '$0.00'; // Reset total on clear
            updateCartDisplay();
        }

    </script>
</body>
</html>
</html>
